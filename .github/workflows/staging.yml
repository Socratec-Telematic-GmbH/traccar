name: Build staging installers

on:
  push:
    branches: [ staging ]           # auto-run on commits to staging
  workflow_dispatch:                 # still allow manual runs
    inputs:
      version:
        description: 'Version'
        required: true
        default: 'preview'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout main repo (staging)
        uses: actions/checkout@v4
        with:
          ref: staging              # ensure baseline is staging
          fetch-depth: 0
          submodules: true

      # Ensure the submodule tracks its staging branch (not just the pinned commit)
      - name: Align submodule to staging
        working-directory: ./traccar-web
        run: |
          git fetch origin staging:staging || true
          git checkout staging

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - run: ./gradlew build

      - uses: actions/setup-node@v4
        with:
          node-version: 21
          cache: npm
          cache-dependency-path: traccar-web/package-lock.json

      - run: npm ci && npm run build
        working-directory: ./traccar-web

      - run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y libgcc-s1:i386 libstdc++6:i386
          sudo apt-get install -y innoextract makeself wine32 s3cmd

      - name: Build installers
        working-directory: ./setup
        run: |
          wget -q http://files.jrsoftware.org/is/5/isetup-5.5.6.exe
          wget -q https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.4+7/OpenJDK21U-jdk_x64_windows_hotspot_21.0.4_7.zip
          wget -q https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.4+7/OpenJDK21U-jdk_x64_linux_hotspot_21.0.4_7.tar.gz
          wget -q https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.4+7/OpenJDK21U-jdk_aarch64_linux_hotspot_21.0.4_7.tar.gz
          ./package.sh "${{ github.event.inputs.version || 'preview' }}"

      - name: Upload installers
        working-directory: ./setup
        env:
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
        run: |
          s3cmd --acl-public --region=eu-central-1 \
          put traccar-*.zip \
          s3://socratec-telematic/smc_staging/ \
          --access_key="$S3_ACCESS_KEY" \
          --secret_key="$S3_SECRET_KEY"

      - name: Trigger traccar-docker workflow_dispatch
        if: ${{ success() && github.ref_name == 'staging' }}
        env:
          PAT: ${{ secrets.TRACCAR_DOCKER_PAT }} # repo+workflow scopes
        run: |
          set -e
          OWNER="Socratec-Telematic-GmbH"
          REPO="traccar-docker"
          WORKFLOW_FILE="deploy-staging.yml"
          REF="staging"
          VERSION="${{ github.event.inputs.version || 'preview' }}"

          curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${PAT}" \
            "https://api.github.com/repos/${OWNER}/${REPO}/actions/workflows/${WORKFLOW_FILE}/dispatches" \
            -d "{\"ref\":\"${REF}\",\"inputs\":{\"version\":\"${VERSION}\"}}"

